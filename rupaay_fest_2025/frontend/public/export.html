<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Export Bookings - CSV Download</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="global.css">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full">
    <h1 class="text-2xl font-bold mb-6 text-center">ðŸ“Š Export Bookings</h1>
    
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Admin Password
      </label>
      <input 
        type="password" 
        id="adminPassword" 
        value="admin123"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Enter admin password"
      />
    </div>
    
    <button 
      onclick="downloadCSV()"
      class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition-colors"
    >
      ðŸ“¥ Download CSV File
    </button>
    
    <div id="error" class="mt-4 text-red-600 text-sm hidden"></div>
    <div id="success" class="mt-4 text-green-600 text-sm hidden"></div>
    
    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
      <h3 class="font-semibold text-sm mb-2">CSV Contains:</h3>
      <ul class="text-xs text-gray-600 space-y-1">
        <li>â€¢ Booking Reference</li>
        <li>â€¢ GITAM Email</li>
        <li>â€¢ Student Name</li>
        <li>â€¢ Registration Number</li>
        <li>â€¢ Seat Number</li>
        <li>â€¢ Event Details</li>
        <li>â€¢ Booking Status & Timestamp</li>
      </ul>
    </div>
  </div>

  <script>
    async function downloadCSV() {
      const password = document.getElementById('adminPassword').value;
      const errorDiv = document.getElementById('error');
      const successDiv = document.getElementById('success');
      
      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');
      
      if (!password) {
        errorDiv.textContent = 'Please enter admin password';
        errorDiv.classList.remove('hidden');
        return;
      }
      
      try {
        const response = await fetch('http://localhost:4000/api/admin/export', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${password}`
          }
        });
        
        if (response.status === 401) {
          errorDiv.textContent = 'Invalid admin password';
          errorDiv.classList.remove('hidden');
          return;
        }
        
        if (!response.ok) {
          throw new Error('Failed to download CSV');
        }
        
        // Get filename from header
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = 'bookings-export.csv';
        if (contentDisposition) {
          const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
          if (filenameMatch) {
            filename = filenameMatch[1].replace(/"/g, '');
          }
        }
        
        // Download file
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        successDiv.textContent = `âœ… Downloaded ${filename} successfully!`;
        successDiv.classList.remove('hidden');
      } catch (error) {
        errorDiv.textContent = 'Error downloading CSV: ' + error.message;
        errorDiv.classList.remove('hidden');
      }
    }
  </script>
  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-bottom-nav md:hidden">
    <a href="index.html"><i class="fas fa-home"></i><div style="font-size:10px">Home</div></a>
    <a href="event-details.html"><i class="fas fa-ticket-alt"></i><div style="font-size:10px">Events</div></a>
    <a href="seat-selection.html"><i class="fas fa-chair"></i><div style="font-size:10px">Seats</div></a>
    <a href="verification.html"><i class="fas fa-user-check"></i><div style="font-size:10px">Verify</div></a>
  </nav>
</body>
</html>
